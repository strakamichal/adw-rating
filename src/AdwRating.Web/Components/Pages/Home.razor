@page "/"
@using AdwRating.Web.Components.Shared
@inject AdwRatingApiClient Api

<PageTitle>ADW Rating — Global Agility Team Rankings</PageTitle>

<HeadContent>
    <meta name="description" content="Independent, data-driven agility team rankings worldwide. Track ratings, compare teams, and explore competition results across all size categories." />
    <meta property="og:title" content="ADW Rating — Global Agility Team Rankings" />
    <meta property="og:description" content="Independent, data-driven agility team rankings worldwide. Track ratings, compare teams, and explore competition results." />
    <meta property="og:url" content="/" />
</HeadContent>

<!-- 3.1 Hero area -->
<section class="hero">
    <div class="container">
        <h1 class="hero__title">The Global Agility Rating</h1>
        <p class="hero__tagline">Independent, data-driven rankings for agility teams worldwide. Find your team, track your progress, compare with the best.</p>
        <div class="hero__search">
            <div class="search-input search-input--hero">
                <span class="search-input__icon" aria-hidden="true">&#128269;</span>
                <input type="search" class="search-input__field" placeholder="Search teams, handlers, competitions..." aria-label="Search">
            </div>
        </div>
    </div>
</section>

<!-- 3.2 Summary stats -->
<section class="container" style="margin-top: calc(-1 * var(--space-8)); position: relative; z-index: 10;">
    @if (!_loaded)
    {
        <LoadingSkeleton Variant="LoadingSkeleton.SkeletonVariant.StatCards" Count="3" />
    }
    else
    {
        <div class="grid-3 mb-8">
            <div class="stat-card">
                <div class="stat-card__value">@_summary.QualifiedTeams.ToString("N0")</div>
                <div class="stat-card__label">Qualified Teams</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__value">@_summary.Competitions.ToString("N0")</div>
                <div class="stat-card__label">Competitions Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__value">@_summary.Runs.ToString("N0")</div>
                <div class="stat-card__label">Total Runs</div>
            </div>
        </div>
    }
</section>

<!-- 3.3 Top Teams Spotlight -->
<section class="container mb-8">
    <div class="section-header">
        <h2>Top Teams Spotlight</h2>
    </div>

    <!-- Mobile: size tabs -->
    <div class="size-tabs pill-group mb-4">
        <a class="pill active" href="#" onclick="switchTab('small', this); return false;">S</a>
        <a class="pill" href="#" onclick="switchTab('medium', this); return false;">M</a>
        <a class="pill" href="#" onclick="switchTab('intermediate', this); return false;">I</a>
        <a class="pill" href="#" onclick="switchTab('large', this); return false;">L</a>
    </div>

    <div class="grid-4">
        @foreach (var col in _spotlightColumns)
        {
            <div class="size-tab-content@(col.SizeCode == "S" ? " active" : "")" id="tab-@col.TabId">
                <div class="spotlight-col__title"><span class="badge badge-size">@col.SizeCode</span> @col.SizeName</div>
                @for (var i = 0; i < col.Teams.Count; i++)
                {
                    var team = col.Teams[i];
                    var rank = i + 1;
                    if (rank == 1)
                    {
                        <a href="/teams/@team.Slug" class="team-card team-card--rank-1 team-card--featured">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="team-card__rank">1</div>
                                <div>
                                    <div class="team-card__handler">@CountryHelper.GetFlag(team.HandlerCountry) @team.HandlerName</div>
                                    <div class="team-card__dog">@team.DogCallName</div>
                                </div>
                            </div>
                            <div class="flex-between">
                                <span class="team-card__rating">@team.Rating.ToString("N0")</span>
                                @if (team.TierLabel != null)
                                {
                                    <span class="badge badge-@team.TierLabel.Value.ToString().ToLowerInvariant()">@team.TierLabel</span>
                                }
                            </div>
                            <div class="mt-2">@TrendMarkup(team)</div>
                        </a>
                    }
                    else
                    {
                        <a href="/teams/@team.Slug" class="team-card team-card--rank-@rank team-card--compact">
                            <div class="flex items-center gap-3">
                                <div class="team-card__rank" style="font-size: var(--font-size-h3);">@rank</div>
                                <div class="flex-1">
                                    <div class="team-card__handler">@CountryHelper.GetFlag(team.HandlerCountry) @team.HandlerName</div>
                                    <div class="team-card__dog">@team.DogCallName</div>
                                </div>
                                <div class="text-right">
                                    <div class="data-number-md">@team.Rating.ToString("N0")</div>
                                    @if (team.TierLabel != null)
                                    {
                                        <span class="badge badge-@team.TierLabel.Value.ToString().ToLowerInvariant()" style="font-size: 10px;">@team.TierLabel</span>
                                    }
                                </div>
                            </div>
                        </a>
                    }
                }
                <div class="mt-3"><a href="/rankings?size=@col.SizeCode" class="text-small">View full rankings &rarr;</a></div>
            </div>
        }
    </div>
</section>

<!-- 3.4 Recent Competitions -->
<section class="container mb-8">
    <div class="section-header">
        <h2>Recent Competitions</h2>
        <a href="/competitions" class="section-header__link">View all competitions &rarr;</a>
    </div>

    @if (_recentCompetitions != null)
    {
        @foreach (var comp in _recentCompetitions.Items)
        {
            <div class="competition-entry@(comp.Tier == 1 ? " competition-entry--major" : "")">
                <div class="competition-entry__info">
                    <div class="competition-entry__name">
                        @comp.Name
                        @if (comp.Tier == 1)
                        {
                            <span class="badge badge-major" style="margin-left: var(--space-2);">Major</span>
                        }
                    </div>
                    <div class="competition-entry__meta">
                        <span>@CountryHelper.GetFlag(comp.Country) @FormatDateRange(comp.Date, comp.EndDate)</span>
                        @if (!string.IsNullOrEmpty(comp.Location))
                        {
                            <span>@comp.Location</span>
                        }
                    </div>
                </div>
                <div class="competition-entry__participants">@comp.ParticipantCount teams</div>
            </div>
        }
    }
</section>

<!-- 3.5 About the Rating -->
<section class="container mb-8">
    <h2>About the Rating</h2>
    <p>
        Ratings are based on the Plackett-Luce model, updated after each competition. Each run is a head-to-head comparison: beat strong teams and your rating goes up more; lose to weaker teams and your rating goes down more. Higher rating equals stronger performance against tough competition.
    </p>
    <p>
        Ratings are comparable across all size categories. The rating scale is centered around 1500, with higher values indicating better performance. Teams are classified into tiers: Elite, Champion, Expert, and Competitor.
    </p>
    <p class="mt-4">
        <a href="/how-it-works">Learn more about how the rating works &rarr;</a>
    </p>
</section>

<script>
    function switchTab(size, el) {
        document.querySelectorAll('.size-tab-content').forEach(function(e) { e.classList.remove('active'); });
        document.querySelectorAll('.size-tabs .pill').forEach(function(e) { e.classList.remove('active'); });
        document.getElementById('tab-' + size).classList.add('active');
        el.classList.add('active');
    }
</script>

@code {
    private record SpotlightColumn(string TabId, string SizeCode, string SizeName, IReadOnlyList<TeamRankingDto> Teams);

    private bool _loaded;
    private RankingSummary _summary = new(0, 0, 0);
    private List<SpotlightColumn> _spotlightColumns = [];
    private PagedResult<CompetitionDetailDto>? _recentCompetitions;

    protected override async Task OnInitializedAsync()
    {
        var summaryTask = Api.GetSummaryAsync();
        var smallTask = Api.GetRankingsAsync(new RankingFilter(SizeCategory.S, null, null, 1, 3));
        var mediumTask = Api.GetRankingsAsync(new RankingFilter(SizeCategory.M, null, null, 1, 3));
        var intermediateTask = Api.GetRankingsAsync(new RankingFilter(SizeCategory.I, null, null, 1, 3));
        var largeTask = Api.GetRankingsAsync(new RankingFilter(SizeCategory.L, null, null, 1, 3));
        var competitionsTask = Api.GetCompetitionsAsync(new CompetitionFilter(null, null, null, null, 1, 5));

        await Task.WhenAll(summaryTask, smallTask, mediumTask, intermediateTask, largeTask, competitionsTask);

        _summary = summaryTask.Result;
        _spotlightColumns =
        [
            new("small", "S", "Small", smallTask.Result.Items),
            new("medium", "M", "Medium", mediumTask.Result.Items),
            new("intermediate", "I", "Intermediate", intermediateTask.Result.Items),
            new("large", "L", "Large", largeTask.Result.Items),
        ];
        _recentCompetitions = competitionsTask.Result;
        _loaded = true;
    }

    private static MarkupString TrendMarkup(TeamRankingDto team)
    {
        if (team.PrevRank == null)
            return new MarkupString("<span class=\"badge badge-new text-small\">NEW</span>");

        var diff = team.PrevRank.Value - team.Rank;
        if (diff > 0)
            return new MarkupString($"<span class=\"trend trend-up text-small\">&#9650; {diff}</span>");
        if (diff < 0)
            return new MarkupString($"<span class=\"trend trend-down text-small\">&#9660; {Math.Abs(diff)}</span>");
        return new MarkupString("<span class=\"trend trend-unchanged text-small\">&mdash;</span>");
    }

    private static string FormatDateRange(DateOnly start, DateOnly? end)
    {
        if (end == null || end == start)
            return start.ToString("MMM d, yyyy");

        if (start.Year == end.Value.Year && start.Month == end.Value.Month)
            return $"{start:MMM} {start.Day}\u2013{end.Value.Day}, {start.Year}";

        if (start.Year == end.Value.Year)
            return $"{start:MMM d}\u2013{end.Value:MMM d}, {start.Year}";

        return $"{start:MMM d, yyyy}\u2013{end.Value:MMM d, yyyy}";
    }
}
